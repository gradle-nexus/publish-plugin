name: E2E tests

on:
  schedule:
    - cron: "0 6 * * MON"
  push:
    branches:
      - master
      - "e2e/**"
  workflow_dispatch:

jobs:
  tests:
    name: "E2E tests on Java ${{ matrix.jdk }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        jdk: [ 8, 11, 17 ]
    steps:
    - name: Checkout project with submodules
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        java-version: 19
        distribution: 'zulu'
    - uses: gradle/gradle-build-action@v2
    - name: Run sanity check
      run: ./gradlew --stacktrace test
    - name: Run E2E tests
      env:
        ORG_GRADLE_PROJECT_sonatypeUsernameE2E: ${{ secrets.SONATYPE_USERNAME_E2E }}
        ORG_GRADLE_PROJECT_sonatypePasswordE2E: ${{ secrets.SONATYPE_PASSWORD_E2E }}
        ORG_GRADLE_PROJECT_signingKeyE2E: ${{ secrets.GPG_SIGNING_KEY_E2E }}
        ORG_GRADLE_PROJECT_signingPasswordE2E: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE_E2E }}
      run: >
        ./gradlew
        --stacktrace
        -PnexusPublishPlugin.test.java=${{ matrix.jdk }}
        -Pe2eVerboseOutput
        e2eTest
